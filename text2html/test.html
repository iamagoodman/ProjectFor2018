<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Title</title>
  <style>
    #container{ overflow: hidden }
    #target,#result { float: left; width: 50%; height: 500px; overflow: auto }
    #btn{ padding: 5px 20px; outline: none; border: none; background: #007aff; color: #fff; border-radius: 5px  }
  </style>
  <script src="jquery-1.7.2.js"></script>
</head>
<body>
<p style="text-align: center">
  <button id="btn">运行</button>
</p>
<div id="container">
  <div id="target" contenteditable="true"></div>
  <div id="result"></div>
</div>
  <script>
    var VdomList = [];
    var RdomList = [];
    $('#btn').on('click',function () {
      var children = $('#target').children();
      var result = [];
      for (var i=0;i<children.length;i++) {
        var child = children[i];
        var tagName = child.tagName;
        if (tagName && tagName!='STYLE') { // 不是style 标签
          try {
            var vdom = createVdom(child);
          }catch (e) {
            console.log(e)
          }
          try {
            var rdom = renderDom(vdom);
          }catch (e) {
            console.log(e)
          }
          VdomList.push(vdom);
          RdomList.push(rdom);
          result.push(child);
          if (rdom) {
            document.getElementById('result').appendChild(rdom);
          }
        }
      }
    });
    function removeEmptyNode(target) {
      $(target).find(':empty').css('background','red');
      $(target).find(":contains(' ')").css('background','blue');
    }
    function isEmptyNode(child) {
      $(child).find(':empty').remove();
    }
    function createVdom(dom) {
      var result = {};
      var reg1 = /^\s$/;
      console.log()
      if (reg1.test(dom.innerText) || (!dom.innerText && dom.tagName!='BR')) {
        result.clear = true;
      }
      result.tag = dom.tagName.toLowerCase() == 'font'?'span':dom.tagName.toLocaleLowerCase();
      result.props = {};
      if (dom.attributes.length>0) {
        Array.prototype.forEach.call(dom.attributes,function (item) {
          result.props[transformKey(item.nodeName)] = item.value
        })
      }
      result.props = filterProps(result.tag,result.props);
      if (dom.childNodes && dom.childNodes.length>0) {
        var filterNodes = Array.prototype.filter.call(dom.childNodes,function (child) {
          return child.nodeName != '#comment'
        })
        result.children = filterNodes.map(function (child) {
          if (child.nodeName == '#text') {
            return createVnode(child)
          } else {
            return createVdom(child)
          }
        })
      } else if (dom.innerText) {
        result.children = [dom.innerText]
      } else {
        result.children = [];
        // result.clear = true;
      }
      return result;
    }
    function createVnode(node) {
      var result = {};
      result.tag = 'textnode';
      result.props = {};
      result.children = [node.textContent || node.nodeValue]
      return result;
    }
    function transformKey(key) {
      var keyObj = {
        class: 'className',
        rowspan: 'rowSpan',
        colspan: 'colSpan'
      }
      if (keyObj[key]) {
        return keyObj[key]
      } else {
        return key
      }
    }
    function renderDom(vdom) { // props tag children
      if (!vdom) return null;
      if (vdom.tag == 'textnode') {
        var dom = document.createTextNode(vdom.children[0]);
        return dom;
      }
      var dom = document.createElement(vdom.tag);
      Object.keys(vdom.props).forEach(function (key) {
        dom[key] = vdom.props[key]
      })
      if (vdom.children.length == 0 && vdom.tag != 'br') {
        return null
      } else if (typeof vdom.children[0] == "string") {
        dom.innerText = vdom.children[0]
      } else {
        vdom.children.forEach(function (child) {
          if (child.children.length!=0 || child.tag=='br') {
            dom.appendChild(renderDom(child))
          }
        })
      }
      return dom;
    }
    function mergeChildren() {

    }
    function filterProps(tagName,props) {
      var filterstyleReg = /(color|background|font-weight)/ig;
      var filterclassReg = /(p|table)/ig;
      var result = {}
      Object.keys(props).forEach(function (key) {
        if (key=='style') {
          var styleList = props[key].split(';');
          var filterList = styleList.filter(function (style) {
            return filterstyleReg.test(style) && style!=''
          });
          for (var i=0;i<filterList.length;i++) {
            filterList[i] = filterList[i].trim()
          }
          if (filterList.length!=0) {
            result[key] = filterList.join(';');
          }
        } else if (key == 'className') {
          if (filterclassReg.test(tagName)){
            result[key] = tagName+'node'
          }
        } else if (key != 'face') {
          result[key] = props[key]
        }
      })
      return result
    }
  </script>
</body>
</html>
